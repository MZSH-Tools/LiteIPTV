# LiteIPTV 设计文档

## 项目目标

为国内用户（尤其老年人）提供精简、稳定的 CCTV 直播源。

## 核心功能

| 功能 | 说明 | 状态 |
|------|------|------|
| 定时调度 | launchd 每小时执行一次 | ✅ |
| 抓取 | 并行从多个上游源获取 IPTV 直播地址，失败自动重试 | ✅ |
| 筛选 | 只保留 CCTV 频道（1-17 + 5+） | ✅ |
| 黑名单 | 过滤指定域名的源 | ✅ |
| 散装源 | 支持手动添加单个频道的备用源 | ✅ |
| IPv6 过滤 | 自动过滤 IPv6 源，仅保留 IPv4 | ✅ |
| 连通性检查 | 快速检查 m3u8 是否可访问 | ✅ |
| 分片测速 | 下载前 5 个 ts 分片评估延迟 | ✅ |
| 分辨率检测 | 使用 ffprobe 解析 ts 分片获取真实分辨率 | ✅ |
| 纯音频过滤 | 检测并过滤只有音频没有视频的源 | ✅ |
| 高清优先 | 优先选择 1080p 源，延迟超限时使用备选 | ✅ |
| 深度验证 | 下载 3 个随机分片验证源真实可用 | ✅ |
| 全局并行 | 所有 URL 同时测速，限制最大并发数 | ✅ |
| 输出 | 生成 `iptv.m3u` 单个文件 | ✅ |
| 智能提交 | 内容无变化时跳过写入和提交 | ✅ |
| 源保留 | 新源未覆盖的频道保留旧源 | ✅ |

## 技术实现

### 运行模式
- launchd 定时调度，每小时执行一次
- 程序执行完毕后退出，下次定时再启动

### 虚拟环境
- 使用 miniconda 创建独立环境，确保环境干净无污染
- 环境名：`LiteIPTV`
- Python 路径：`/opt/homebrew/Caskroom/miniconda/base/envs/LiteIPTV/bin/python3`
- 依赖：见 `requirements.txt`

### IPv6 过滤
- 解析 URL 的 hostname
- 检测 `[::1]` 格式或包含 `:` 的地址
- 自动过滤，仅保留 IPv4 源

### 抓取重试
- 抓取失败时自动重试，可配置重试次数和间隔

### 纯音频检测
- 使用 ffprobe 检查 ts 分片是否包含视频流
- 只有音频没有视频的源会被过滤

### 测速流程

1. **快速连通性检查**：5 秒超时，验证 m3u8 是否包含分片信息
2. **连通测速**：下载前 5 个 ts 分片，验证连通性并记录延迟
3. **按延迟排序**：延迟低的源优先
4. **深度验证**：下载 3 个随机分片验证可用性
5. **分辨率检测**：使用 ffprobe 解析分片获取真实分辨率
6. **纯音频过滤**：过滤只有音频没有视频的源
7. **高清优先选源**：优先选择 1080p，延迟超限时使用备选

### 源保留机制
- 生成新文件前读取现有 iptv.m3u
- 新源覆盖旧源（找到更好的）
- 某频道本次没找到可用源时，保留旧源

## 配置文件

`config.json` 结构：

```json
{
  "设置": {
    "抓取重试次数": 3,
    "抓取重试间隔秒": 3,
    "测速超时秒": 30,
    "最大并发数": 500,
    "高清延迟阈值毫秒": 2000
  },
  "黑名单": [
    "freetv.top",
    "hebtv.com"
  ],
  "上游源": [
    "https://example.com/iptv.m3u"
  ],
  "散装源": {
    "CCTV-1": ["http://example.com/cctv1.m3u8"],
    "CCTV-2": ["http://example.com/cctv2.m3u8"]
  }
}
```

| 参数 | 说明 | 默认值 |
|------|------|--------|
| 抓取重试次数 | 抓取失败时的重试次数 | 3 |
| 抓取重试间隔秒 | 每次重试之间的等待时间 | 3 |
| 测速超时秒 | 单次分片下载超时时间 | 30 |
| 最大并发数 | 同时测速的最大 URL 数量 | 500 |
| 高清延迟阈值毫秒 | 延迟超过此值时停止寻找 1080p | 2000 |
| 黑名单 | 域名列表，匹配的源会被过滤 | [] |
| 散装源 | 手动添加的单频道源，按频道 ID 分组 | {} |

## 源覆盖

### 上游源（23个）
- GitHub 项目：Guovin、vbskycn、YanG-1989、suxuang、hujingguang、zbefine、vamoschuck、Kimentanm、YueChan、BigBigGrandG、imDazui、fanmingming、kimcrowing、joevess
- 第三方服务：live.iptv-free.com、live.zbds.top、live.izbds.com、live.hacks.tools、epg.pw、yuanzl77

### 散装源（9个运营商/地区）
| 来源 | 域名/IP | 覆盖频道 |
|------|---------|----------|
| 黑龙江移动 | ottrrs.hl.chinamobile.com | 全部 18 个 |
| 福建移动 | 183.251.61.207 | 10 个 |
| 陕西移动 | 39.134.24.x | 6 个 |
| 湖北 | 112.46.105.20 | 11 个 |
| 山东 | 58.57.40.22 | 6 个 |
| 北邮 | ivi.bupt.edu.cn | 4 个（高清） |
| 江苏移动 | 223.110.245.x | 2 个 |
| 江苏gitv | 223.110.242.130 | 4 个 |
| 湖北2 | 111.43.126.240 | 2 个 |

## 频道范围

CCTV-1 至 CCTV-17，共 18 个频道。

## 运行环境

- **设备**：Mac Mini（国内公网 IP）
- **虚拟环境**：conda 环境 `LiteIPTV`
- **运行模式**：launchd 定时调度，每小时执行一次
- **自动部署**：仅在源发生变化时 git push
- **地区限制**：以山西运城网络环境测试为主

## 提交策略

- 生成前对比内容，相同则跳过写入
- 检查 git diff 和未跟踪文件
- 仅在有变化时提交推送
- commit 信息格式：`update: YYYY-MM-DD HH:mm`

## 文件结构

```
LiteIPTV/
├── main.py                    # 主程序
├── config.json                # 配置文件（上游源、散装源、黑名单）
├── iptv.m3u                   # 直播源输出
├── com.liteiptv.update.plist  # launchd 配置
├── Logs/                      # 日志目录（Windows）
├── ~/Library/Logs/LiteIPTV/   # 日志目录（macOS）
└── Claude/                    # 设计文档
```

## 开发进度

- [x] 项目初始化
- [x] 并行抓取模块
- [x] 频道筛选模块
- [x] IPv6 过滤
- [x] 黑名单过滤
- [x] 散装源支持
- [x] 连通性检查
- [x] 分片测速
- [x] 全局并行优化
- [x] 深度验证（随机分片验证）
- [x] 分辨率检测（ffprobe）
- [x] 纯音频过滤（ffprobe 检测视频流）
- [x] 高清优先选源
- [x] 智能提交（内容无变化跳过）
- [x] 定时任务配置
- [x] 中文日志输出
- [x] 跨平台日志目录
- [x] 源保留（新源未覆盖时保留旧源）
- [x] 抓取重试
