# LiteIPTV 设计文档

## 项目目标

为国内用户（尤其老年人）提供精简、稳定的 CCTV 直播源。

## 核心功能

| 功能 | 说明 | 状态 |
|------|------|------|
| 定时调度 | launchd 每天凌晨 3 点执行 | ✅ |
| 抓取 | 并行从多个上游源获取 IPTV 直播地址，失败自动重试 | ✅ |
| 筛选 | 只保留 CCTV 频道（1-17 + 5+） | ✅ |
| IPv6 过滤 | 自动过滤 IPv6 源，仅保留 IPv4 | ✅ |
| 连通性检查 | 快速检查 m3u8 是否可访问 | ✅ |
| 分片测速 | 下载前 5 个 ts 分片评估真实播放稳定性 | ✅ |
| 全局并行 | 所有 URL 同时测速，限制最大并发数 | ✅ |
| 自动禁用 | 完全失效的上游源自动禁用 | ✅ |
| 输出 | 生成 `iptv.m3u` 单个文件 | ✅ |
| 智能提交 | 内容无变化时跳过写入和提交 | ✅ |
| 源保护 | 无可用源时保留旧文件不覆盖 | ✅ |

## 技术实现

### 运行模式
- launchd 定时调度，每天凌晨 3 点执行一次
- 程序执行完毕后退出，下次定时再启动

### IPv6 过滤
- 解析 URL 的 hostname
- 检测 `[::1]` 格式或包含 `:` 的地址
- 自动过滤，仅保留 IPv4 源

### 抓取重试
- 抓取失败时自动重试，可配置重试次数和间隔
- 多次重试仍失败则自动禁用该上游源

### 测速流程（参考 iptv-api）

1. **快速连通性检查**：5 秒超时，验证 m3u8 是否包含分片信息
2. **多轮测速**：对可连接的源进行多轮测速
3. **综合评分**：根据速率、稳定性、延迟计算评分
4. **选优**：每个频道选择评分最高的源

### 全局轮次测速
- 收集所有频道的所有 URL，全局去重
- 全局轮次：所有 URL 测完一轮 → 等待间隔 → 下一轮
- 分批并发测速，限制最大并发数

### 自动禁用失效源
- 统计每个上游源的 CCTV 频道连通情况
- 如果某上游源所有 CCTV 频道全部失败，自动禁用该源
- 可通过配置关闭此功能

### 综合评分算法

**测试流程**：
1. 获取 m3u8 内容，处理 Master Playlist
2. 解析 ts 分片地址
3. 并发下载前 5 个分片
4. 统计每个分片的下载指标
5. 计算综合评分

**测速指标**：
- `speed`：平均下载速率（bytes/s）
- `ttfb`：平均首字节时间
- `speedStd`：分片间速率标准差（稳定性核心指标）
- `segments`：成功下载的分片数

**评分权重**：

| 指标 | 权重 | 说明 |
|------|------|------|
| 分片稳定性 | 30% | 单次测试内分片速率波动 |
| 轮次稳定性 | 20% | 不同时间点测速结果波动 |
| 带宽 | 30% | 以 2Mbps 为满分标准 |
| 连接速度 | 20% | TTFB 越小越好 |

**评分公式**：

```
分片稳定性分 = 100 - min(100, 分片速率标准差/平均速率 × 100)
轮次稳定性分 = 100 - min(100, 轮次速率标准差/平均速率 × 100)
带宽分 = min(100, 平均速率 / 250000 × 100)
连接分 = max(0, 100 - 平均TTFB × 200)

综合评分 = (分片稳定性×0.3 + 轮次稳定性×0.2 + 带宽×0.3 + 连接×0.2) × 成功率²
```

成功率平方作为惩罚系数，不稳定的源会被大幅降权。

## 配置文件

`config.json` 结构：

```json
{
  "设置": {
    "抓取重试次数": 3,
    "抓取重试间隔秒": 3,
    "测速轮数": 3,
    "测速间隔秒": 300,
    "测速超时秒": 30,
    "最大并发数": 500,
    "自动禁用失效源": true
  },
  "黑名单": [
    "example.com"
  ],
  "上游源": [
    {
      "名称": "source-name",
      "地址": "https://...",
      "启用": true
    }
  ]
}
```

| 参数 | 说明 | 默认值 |
|------|------|--------|
| 抓取重试次数 | 抓取失败时的重试次数 | 3 |
| 抓取重试间隔秒 | 每次重试之间的等待时间 | 3 |
| 测速轮数 | 每个 URL 测试的次数 | 3 |
| 测速间隔秒 | 每轮测速之间的等待时间 | 300 |
| 测速超时秒 | 单次分片下载超时时间 | 30 |
| 最大并发数 | 同时测速的最大 URL 数量 | 500 |
| 自动禁用失效源 | 上游源所有频道失效时自动禁用 | true |

## 频道范围

CCTV-1 至 CCTV-17，共 18 个频道。

## 运行环境

- **设备**：Mac Mini（国内公网 IP）
- **运行模式**：launchd 定时调度，每天凌晨 3 点执行
- **自动部署**：仅在源发生变化时 git push

## 提交策略

- 生成前对比内容，相同则跳过写入
- 检查 git diff 和未跟踪文件
- 仅在有变化时提交推送
- commit 信息格式：`update: YYYY-MM-DD HH:mm`

## 文件结构

```
LiteIPTV/
├── main.py                    # 主程序
├── config.json                # 上游源配置
├── iptv.m3u                   # 直播源输出
├── test.sh                    # 快速验证脚本
├── com.liteiptv.update.plist  # launchd 配置
├── ~/Library/Logs/LiteIPTV/   # 日志目录（macOS 标准位置）
└── Claude/                    # 设计文档
```

## 开发进度

- [x] 项目初始化
- [x] 并行抓取模块
- [x] 频道筛选模块
- [x] IPv6 过滤
- [x] 连通性检查
- [x] 分片测速（参考 iptv-api）
- [x] 全局并行优化
- [x] 择优评分算法
- [x] 自动禁用失效源
- [x] 智能提交（内容无变化跳过）
- [x] 定时任务配置
- [x] 中文日志输出
- [x] 日志输出到 macOS 标准位置
- [x] 源保护（无可用源时保留旧文件）
- [x] 抓取重试（失败自动重试，多次失败禁用）
- [x] 全局轮次测速
