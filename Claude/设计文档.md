# LiteIPTV 设计文档

## 项目目标

为国内用户（尤其老年人）提供精简、稳定的 CCTV 直播源。

## 核心功能

| 功能 | 说明 | 状态 |
|------|------|------|
| 抓取 | 并行从多个上游源获取 IPTV 直播地址 | ✅ |
| 筛选 | 只保留 CCTV 频道（1-17 + 5+） | ✅ |
| 双栈测速 | 使用 curl -4/-6 分别测试 IPv4/IPv6 连通性 | ✅ |
| 全局并行 | 所有 URL 同时测速，限制最大并发数 | ✅ |
| 自动禁用 | 完全失效的上游源自动禁用 | ✅ |
| 输出 | 生成 `ipv4.m3u` 和 `ipv6.m3u` 两个文件 | ✅ |
| 智能提交 | 内容无变化时跳过写入和提交 | ✅ |

## 技术实现

### 双栈测速
- 不再通过 URL 格式判断 IPv4/IPv6
- 对每个 URL 同时使用 `curl -4` 和 `curl -6` 测试
- 能连通哪个协议就归类到哪个文件

### 全局并行
- 收集所有频道的所有 URL
- 使用 `asyncio.Semaphore` 限制最大并发数（默认 50）
- 一次性并行测速所有 URL

### 自动禁用失效源
- 统计每个上游源的 CCTV 频道连通情况
- 如果某上游源所有 CCTV 频道全部失败，自动禁用该源
- 可通过配置关闭此功能

## 配置文件

`config.json` 结构：

```json
{
  "设置": {
    "测速轮数": 5,
    "测速间隔秒": 60,
    "自动禁用失效源": true
  },
  "上游源": [
    {
      "名称": "source-name",
      "地址": "https://...",
      "启用": true
    }
  ]
}
```

## 频道范围

CCTV-1 至 CCTV-17，共 18 个频道。

## 运行环境

- **设备**：Mac Mini（国内公网 IP）
- **定时任务**：launchd，每小时运行一次
- **自动部署**：仅在源发生变化时 git push

## 测速策略

- 默认 5 轮测速，每轮间隔 60 秒
- 综合评分 = 成功率 / (平均响应时间 + 0.1)
- 每个频道保留 IPv4 和 IPv6 各自得分最高的源

## 提交策略

- 生成前对比内容，相同则跳过写入
- 检查 git diff 和未跟踪文件
- 仅在有变化时提交推送
- commit 信息格式：`update: YYYY-MM-DD HH:mm`

## 文件结构

```
LiteIPTV/
├── main.py                    # 主程序
├── config.json                # 上游源配置
├── ipv4.m3u                   # IPv4 源输出
├── ipv6.m3u                   # IPv6 源输出
├── test.sh                    # 快速验证脚本
├── com.liteiptv.update.plist  # launchd 配置
├── logs/                      # 日志目录
└── Claude/                    # 设计文档
```

## 开发进度

- [x] 项目初始化
- [x] 并行抓取模块
- [x] 频道筛选模块
- [x] 双栈测速模块
- [x] 全局并行优化
- [x] 自动禁用失效源
- [x] 智能提交（内容无变化跳过）
- [x] 定时任务配置
