# LiteIPTV 设计文档

## 项目目标

为国内用户（尤其老年人）提供精简、稳定的 CCTV 直播源。

## 核心功能

| 功能 | 说明 | 状态 |
|------|------|------|
| 长驻运行 | Python 进程常驻，launchd 保活，自主调度 | ✅ |
| 抓取 | 并行从多个上游源获取 IPTV 直播地址，失败自动重试 | ✅ |
| 筛选 | 只保留 CCTV 频道（1-17 + 5+） | ✅ |
| 双栈测速 | 使用 curl -4/-6 分别测试 IPv4/IPv6 连通性 | ✅ |
| 全局并行 | 所有 URL 同时测速，限制最大并发数 | ✅ |
| 自动禁用 | 完全失效的上游源自动禁用 | ✅ |
| 输出 | 生成 `ipv4.m3u` 和 `ipv6.m3u` 两个文件 | ✅ |
| 智能提交 | 内容无变化时跳过写入和提交 | ✅ |
| 源保护 | 无可用源时保留旧文件不覆盖 | ✅ |

## 技术实现

### 长驻运行模式
- Python 进程启动后常驻运行，自主控制执行间隔
- launchd 仅负责启动和保活（KeepAlive），进程意外退出会自动重启
- 所有配置集中在 config.json，plist 无需修改运行参数

### 双栈测速
- 不通过 URL 格式判断 IPv4/IPv6
- 对每个 URL 同时使用 `curl -4` 和 `curl -6` 测试
- 能连通哪个协议就归类到哪个文件

### 抓取重试
- 抓取失败时自动重试，可配置重试次数和间隔
- 多次重试仍失败则自动禁用该上游源

### 全局轮次测速
- 收集所有频道的所有 URL，全局去重
- 全局轮次：所有 URL 测完一轮 → 等待间隔 → 下一轮
- 分批并发测速，限制最大并发数

### 自动禁用失效源
- 统计每个上游源的 CCTV 频道连通情况
- 如果某上游源所有 CCTV 频道全部失败，自动禁用该源
- 可通过配置关闭此功能

### 综合评分算法

模拟真实播放场景：解析 m3u8 并连续下载多个 ts 分片进行测试。

**测试流程**：
1. 获取 m3u8 内容
2. 解析出 ts 分片地址
3. 连续下载前 5 个分片
4. 统计每个分片的下载指标
5. 计算综合评分

**测速指标**：
- `speed`：平均下载速率（bytes/s）
- `ttfb`：平均首字节时间
- `speedStd`：分片间速率标准差（稳定性核心指标）
- `segments`：成功下载的分片数

**评分权重**：

| 指标 | 权重 | 计算方式 |
|------|------|----------|
| 稳定性 | 40% | 速率波动越小越好（变异系数） |
| 带宽 | 35% | 以 2Mbps 为满分标准 |
| 连接速度 | 15% | TTFB 越小越好 |
| 抖动 | 10% | TTFB 波动越小越好 |

**评分公式**：

```
稳定性分 = 100 - min(100, 速率标准差/平均速率 × 100)
带宽分 = min(100, 平均速率 / 250000 × 100)
连接分 = max(0, 100 - 平均TTFB × 200)
抖动分 = max(0, 100 - TTFB标准差 × 500)

综合评分 = (稳定性×0.4 + 带宽×0.35 + 连接×0.15 + 抖动×0.1) × 成功率²
```

成功率平方作为惩罚系数，不稳定的源会被大幅降权。

**示例**：

| 源 | 成功率 | 速率 | 稳定性 | 带宽 | 综合评分 |
|----|--------|------|--------|------|----------|
| A | 100% | 300KB/s | 95 | 100 | **75** |
| B | 100% | 50KB/s | 90 | 20 | **48** |
| C | 67% | 200KB/s | 80 | 80 | **30** |

评分越高越好，每个频道选择 IPv4 和 IPv6 各自评分最高的源。

## 配置文件

`config.json` 结构：

```json
{
  "设置": {
    "抓取重试次数": 3,
    "抓取重试间隔秒": 3,
    "测速轮数": 3,
    "测速间隔秒": 300,
    "测速超时秒": 30,
    "最大并发数": 500,
    "自动禁用失效源": true
  },
  "上游源": [
    {
      "名称": "source-name",
      "地址": "https://...",
      "启用": true
    }
  ]
}
```

| 参数 | 说明 | 默认值 |
|------|------|--------|
| 抓取重试次数 | 抓取失败时的重试次数 | 3 |
| 抓取重试间隔秒 | 每次重试之间的等待时间 | 3 |
| 测速轮数 | 每个 URL 测试的次数 | 3 |
| 测速间隔秒 | 每轮测速之间的等待时间 | 300 |
| 测速超时秒 | 单次分片下载超时时间 | 30 |
| 最大并发数 | 同时测速的最大 URL 数量 | 500 |
| 自动禁用失效源 | 上游源所有频道失效时自动禁用 | true |

## 频道范围

CCTV-1 至 CCTV-17，共 18 个频道。

## 运行环境

- **设备**：Mac Mini（国内公网 IP）
- **运行模式**：launchd 定时调度，每天凌晨 3 点执行
- **自动部署**：仅在源发生变化时 git push

## 提交策略

- 生成前对比内容，相同则跳过写入
- 检查 git diff 和未跟踪文件
- 仅在有变化时提交推送
- commit 信息格式：`update: YYYY-MM-DD HH:mm`

## 文件结构

```
LiteIPTV/
├── main.py                    # 主程序
├── config.json                # 上游源配置
├── ipv4.m3u                   # IPv4 源输出
├── ipv6.m3u                   # IPv6 源输出
├── test.sh                    # 快速验证脚本
├── com.liteiptv.update.plist  # launchd 配置
├── ~/Library/Logs/LiteIPTV/   # 日志目录（macOS 标准位置）
└── Claude/                    # 设计文档
```

## 开发进度

- [x] 项目初始化
- [x] 并行抓取模块
- [x] 频道筛选模块
- [x] 双栈测速模块
- [x] 全局并行优化
- [x] 择优评分算法
- [x] 自动禁用失效源
- [x] 智能提交（内容无变化跳过）
- [x] 定时任务配置
- [x] 中文日志输出
- [x] 日志输出到 macOS 标准位置
- [x] 源保护（无可用源时保留旧文件）
- [x] 抓取重试（失败自动重试，多次失败禁用）
- [x] 全局轮次测速（所有URL测完一轮再等待间隔）
- [x] 长驻运行模式（Python 自主调度，launchd 保活）
